# EFK Stack on Kubernetes

The EFK stack combines **Elasticsearch**, **Fluentd**, and **Kibana** to efficiently manage, search, and visualize logs generated by applications running in Kubernetes clusters.

- **Elasticsearch**: A highly scalable search and analytics engine.
- **Fluentd**: An open-source data collector for unified logging, allowing the collection and transformation of data for better use and understanding.
- **Kibana**: The visualization layer, offering a powerful interface to view and analyze the data stored in Elasticsearch.

## Custom Fluentd Plugins for Log Enrichment

Log enrichment adds additional context to your logs, making them more informative and easier to analyze. You can develop or configure custom Fluentd plugins to enrich logs with extra metadata, such as Kubernetes labels, environment information, or application-specific data.

### Creating a Custom Fluentd Filter Plugin

1. **Set up Fluentd in Kubernetes**: Ensure Fluentd is running, ideally as a `DaemonSet`, for log collection across the cluster.
  
2. **Develop the Plugin**: Fluentd plugins are typically written in Ruby. Here's an example of a simple custom filter plugin that adds a static field to all logs:

    ```ruby
    require 'fluent/plugin/filter'

    module Fluent::Plugin
      class MyCustomFilter < Filter
        Fluent::Plugin.register_filter('my_custom_filter', self)

        def configure(conf)
          super
          # Add any required configuration parameters here
        end

        def filter(tag, time, record)
          # Add a custom field to the record
          record["additional_info"] = "static_value"
          record
        end
      end
    end
    ```

3. **Install the Plugin**: After developing the plugin, package it as a Ruby gem and install it in your Fluentd environment using `fluent-gem`.

4. **Configure Fluentd to Use the Plugin**: Add the custom plugin to your Fluentd configuration:

    ```conf
    <filter **>
      @type my_custom_filter
    </filter>
    ```

### Testing and Debugging

Make sure to thoroughly test your custom Fluentd plugin in a development environment before deploying to production. Fluentd's logs can provide useful information for debugging any issues that arise.

---

## Elasticsearch Index Management for Performance

Proper index management is essential for maintaining the performance and scalability of your Elasticsearch cluster. This can be achieved through strategies like **index rollover**, **sharding**, and **replicas configuration**.

### Index Rollover

Index rollover helps manage indices based on conditions like size, age, or document count. New indices are created automatically when specified conditions are met.

1. **Create an Index Template**:

    ```bash
    PUT _template/my_logs_template
    {
      "index_patterns": ["logs-*"],
      "settings": {
        "number_of_shards": 3,
        "number_of_replicas": 1
      }
    }
    ```

2. **Set up an Index Lifecycle Management (ILM) Policy**:

    ```bash
    PUT _ilm/policy/my_logs_policy
    {
      "policy": {
        "phases": {
          "hot": {
            "actions": {
              "rollover": {
                "max_size": "5GB",
                "max_age": "30d"
              }
            }
          },
          "delete": {
            "min_age": "90d",
            "actions": {
              "delete": {}
            }
          }
        }
      }
    }
    ```

3. **Apply the ILM Policy to Your Index Template**:

    ```bash
    PUT _template/my_logs_template
    {
      "settings": {
        "index.lifecycle.name": "my_logs_policy"
      }
    }
    ```

### Sharding and Replicas Configuration

- **Shards**: Distribute data across multiple nodes to improve performance. A typical cluster has at least 3 master-eligible nodes for high availability.
  
- **Replicas**: Ensure high availability and redundancy. In the event of a node failure, replicas ensure that no data is lost.

Configure the number of shards and replicas:

```bash
PUT /my_logs-000001
{
  "settings": {
    "index": {
      "number_of_shards": 3, 
      "number_of_replicas": 2 
    }
  }
}
